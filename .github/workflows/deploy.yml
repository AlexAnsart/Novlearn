name: Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Build frontend
      working-directory: ./frontend
      run: npm run build
      env:
        NODE_ENV: production
    
    - name: Create .env file for backend
      run: |
        echo "# Novlearn Backend Configuration" > backend/.env
        echo "APP_ENV=production" >> backend/.env
        echo "DEBUG=False" >> backend/.env
        echo "HOST=0.0.0.0" >> backend/.env
        echo "PORT=8000" >> backend/.env
        echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> backend/.env
        echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> backend/.env
        echo "CORS_ORIGINS=https://novlearn.fr,https://www.novlearn.fr" >> backend/.env
        echo "LOG_LEVEL=${{ secrets.LOG_LEVEL || 'INFO' }}" >> backend/.env
    
    - name: Deploy frontend code to VPS
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "frontend/**"
        target: "/opt/novlearn"
        strip_components: 0
    
    - name: Deploy backend code and .env to VPS
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "backend/**,backend/.env"
        target: "/opt/novlearn"
        strip_components: 0
    
    - name: Deploy deploy script to VPS
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "deploy.sh"
        target: "/opt/novlearn"
        strip_components: 0
    
    - name: Cleanup old systemd service files
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          # Supprimer les fichiers systemd s'ils existent d√©j√† dans /tmp/
          rm -rf /tmp/novlearn-backend.service
          rm -rf /tmp/novlearn-frontend.service
    
    - name: Deploy systemd services to VPS
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "systemd/*.service"
        target: "/tmp/"
        strip_components: 1
    
    - name: Setup and deploy application
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          # Cr√©er les r√©pertoires si n√©cessaire
          sudo mkdir -p /opt/novlearn
          sudo chown -R $USER:$USER /opt/novlearn
          
          # Installer Node.js et npm si n√©cessaire
          if ! command -v node &> /dev/null || ! command -v npm &> /dev/null; then
            echo "üì¶ Installation de Node.js et npm..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
            # S'assurer que npm est install√© (NodeSource inclut g√©n√©ralement npm, mais v√©rifions)
            if ! command -v npm &> /dev/null; then
              echo "‚ö†Ô∏è  npm n'est pas disponible, installation via apt..."
              sudo apt-get install -y npm
            fi
          fi
          
          # Trouver les emplacements de node et npm
          NODE_PATH=$(which node 2>/dev/null || echo "/usr/bin/node")
          NPM_PATH=$(which npm 2>/dev/null || echo "/usr/bin/npm")
          
          # V√©rifier et mettre √† jour le PATH pour Node.js/npm
          export PATH="/usr/bin:/usr/local/bin:$PATH"
          
          # Si node ou npm sont dans un autre r√©pertoire, l'ajouter au PATH
          if [ -f "$NODE_PATH" ]; then
            NODE_DIR=$(dirname "$NODE_PATH")
            export PATH="$NODE_DIR:$PATH"
          fi
          if [ -f "$NPM_PATH" ]; then
            NPM_DIR=$(dirname "$NPM_PATH")
            export PATH="$NPM_DIR:$PATH"
          fi
          
          # V√©rifier que node et npm sont accessibles
          echo "üîç V√©rification de Node.js et npm..."
          if ! node --version; then
            echo "‚ùå Erreur: node non accessible"
            echo "Recherche de node dans le syst√®me..."
            find /usr -name node 2>/dev/null | head -5
            exit 1
          fi
          if ! npm --version; then
            echo "‚ùå Erreur: npm non accessible"
            echo "Recherche de npm dans le syst√®me..."
            find /usr -name npm 2>/dev/null | head -5
            exit 1
          fi
          echo "‚úÖ Node.js $(node --version) et npm $(npm --version) sont disponibles"
          
          # Installer les services systemd
          echo "üîß Configuration des services systemd..."
          
          # Service backend
          if [ ! -f /etc/systemd/system/novlearn-backend.service ]; then
            sudo sed "s/YOUR_USERNAME/$USER/g" /tmp/novlearn-backend.service > /tmp/novlearn-backend.service.tmp
            sudo mv /tmp/novlearn-backend.service.tmp /etc/systemd/system/novlearn-backend.service
            sudo systemctl daemon-reload
            sudo systemctl enable novlearn-backend
          else
            if sudo systemctl is-enabled novlearn-backend 2>&1 | grep -q "masked"; then
              echo "üîì D√©masquage du service novlearn-backend..."
              sudo systemctl unmask novlearn-backend
              sudo systemctl enable novlearn-backend
            fi
          fi
          
          # Service frontend
          if [ ! -f /etc/systemd/system/novlearn-frontend.service ]; then
            sudo sed "s/YOUR_USERNAME/$USER/g" /tmp/novlearn-frontend.service > /tmp/novlearn-frontend.service.tmp
            sudo mv /tmp/novlearn-frontend.service.tmp /etc/systemd/system/novlearn-frontend.service
            sudo systemctl daemon-reload
            sudo systemctl enable novlearn-frontend
            sudo systemctl start novlearn-frontend
          else
            if sudo systemctl is-enabled novlearn-frontend 2>&1 | grep -q "masked"; then
              echo "üîì D√©masquage du service novlearn-frontend..."
              sudo systemctl unmask novlearn-frontend
              sudo systemctl enable novlearn-frontend
            fi
            # D√©marrer le service s'il n'est pas actif
            if ! sudo systemctl is-active --quiet novlearn-frontend; then
              sudo systemctl start novlearn-frontend
            fi
          fi
          
          # Naviguer vers le r√©pertoire de d√©ploiement
          cd /opt/novlearn
          
          # Rendre le script de d√©ploiement ex√©cutable
          chmod +x deploy.sh
          
          # Ex√©cuter le script de d√©ploiement avec le PATH correct
          # S'assurer que node et npm sont dans le PATH pour le script
          export PATH="/usr/bin:/usr/local/bin:$PATH"
          ./deploy.sh
    
    - name: Verify deployment
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          # Attendre un peu pour le d√©marrage
          sleep 5
          
          # V√©rifier que le fichier .env existe
          echo "üîç V√©rification de la configuration..."
          if [ ! -f /opt/novlearn/backend/.env ]; then
            echo "‚ùå Erreur: fichier .env introuvable dans /opt/novlearn/backend/"
            exit 1
          fi
          
          # V√©rifier que le backend r√©pond
          echo "üîç Test du health check backend..."
          curl -f http://localhost:8000/api/health || {
            echo "‚ùå Le health check backend a √©chou√©"
            echo "Logs du backend (50 derni√®res lignes):"
            sudo journalctl -u novlearn-backend -n 50 || echo "Aucun log trouv√©"
            exit 1
          }
          
          # V√©rifier que le frontend r√©pond
          echo "üîç Test du frontend..."
          sleep 3
          curl -f http://localhost:3000 || {
            echo "‚ùå Le frontend ne r√©pond pas"
            echo "Logs du frontend (50 derni√®res lignes):"
            sudo journalctl -u novlearn-frontend -n 50 || echo "Aucun log trouv√©"
            exit 1
          }
          
          echo "‚úÖ D√©ploiement v√©rifi√© avec succ√®s"

